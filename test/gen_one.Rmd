---
title: "Data Preparation"
params:
  out_dir: "processed"
  x_path: "/vsicurl/https://glaciersblob.blob.core.windows.net/glaciersdata-kris/corrected/region-corrected.vrt"
  y_path: "/vsicurl/https://glaciersblob.blob.core.windows.net/glaciersdata-kris/glaciers.geojson"
  basins: "https://uwmadison.box.com/shared/static/2ptmi9b4gt5d5vyusju5u8kn5n1s6hnd.csv"
  n_patches: 10
  #basins: "https://uwmadison.box.com/shared/static/iilcsf3bbois8tmt7pklriu219s4wlu6.csv" # for test basins
  B: 1 
---

```{r setup, include=FALSE}
rm(list=setdiff(ls(), "params"))
knitr::opts_chunk$set(echo = TRUE, cache = FALSE, message = FALSE, warning = FALSE)
```

```{r}
library("RStoolbox")
library("abind")
library("dplyr")
library("gdalUtils")
library("ggplot2")
library("gridExtra")
library("purrr")
library("raster")
library("readr")
library("reticulate")
library("sf")
library("stringr")
library("tidyr")
# setting up python environment
use_condaenv("mappingvis")
np <- import("numpy")
source("data_corrected.R")
theme_set(theme_minimal())
set.seed(params$B)
```

Read geojson.

```{r}
y_path <- file.path(params$y_path)
basins <- read_csv(params$basins)
y <- read_sf(y_path) %>%
  filter(Sub_basin %in% basins$Sub_basin)
print("read sf success")
ys <- y %>% split(.$Glaciers)
```
Get sampling locations.

```{r}
centers <- y %>%
  st_sample(params$n_patches, type = "random", by_polygon = FALSE) %>%
  st_coordinates()
colnames(centers) <- c("Longitude", "Latitude")
x_path <- file.path(params$x_path)
```

```{r}
point <- st_point(centers[1,], dim = "XY") %>%
  st_buffer(0.1) %>%
  st_geometry()
x_raster <- read_subset(x_path, st_bbox(point))
subset_inputs <- c(1:11)
x <- as.array(x_raster)
x <- x[,, subset_inputs]
#if(!is.na(x)){
    #if(mean(is.na(x))<0.2){x <- impute_na(x) %>%
      #equalize_input(range = c(-1, 1))}else{stop("Too many missing values.")}
#}else{stop("Too many missing values.")}

x <- impute_na(x) %>%
      equalize_input(range = c(-1, 1))
      
patch<-list(x = x, meta = point, raster = x_raster)
```

```{r}
patch_y <- label_mask(ys, patch$raster)
```

```{r}
unlink(params$out_dir, force = TRUE)
dir.create(params$out_dir, recursive = TRUE)
np$save(file.path(params$out_dir, str_c("x-", 1, ".npy")), patch$x)
np$save(file.path(params$out_dir, str_c("y-", 1, ".npy")), patch_y)
write_sf(patch$meta, file.path(params$out_dir, str_c("geo-", 1, ".geojson")))
```

```{r}
centers<-cbind(centers,c(1:params$n_patches))
colnames(centers)<-c("Longitude","Latitude","ID")
write.csv(centers,file.path(params$out_dir, paste0("centers-", params$B, ".csv")))
```
